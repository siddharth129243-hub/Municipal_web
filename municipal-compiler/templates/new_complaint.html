{% extends "base.html" %}

{% block title %}New Complaint - Municipal Compiler{% endblock %}

{% block content %}
<div class="fade-in">
    <h1><i class="fas fa-plus-circle"></i> File New Complaint</h1>
    <p>Report issues in your area to municipal authorities</p>
</div>

<form class="complaint-form" method="POST" action="{{ url_for('new_complaint') }}" enctype="multipart/form-data">
    <div class="form-group">
        <label for="title"><i class="fas fa-heading"></i> Complaint Title</label>
        <input type="text" id="title" name="title" class="form-control" required 
               placeholder="e.g., Pothole on Main Road, Street Light Not Working">
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="category"><i class="fas fa-tag"></i> Category</label>
            <select id="category" name="category" class="form-control" required>
                <option value="">Select Category</option>
                <option value="Road">Road & Infrastructure</option>
                <option value="Water">Water Supply</option>
                <option value="Electricity">Electricity</option>
                <option value="Sanitation">Sanitation & Garbage</option>
                <option value="Parks">Parks & Gardens</option>
                <option value="Traffic">Traffic & Signals</option>
                <option value="Other">Other Issues</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="priority"><i class="fas fa-exclamation-triangle"></i> Priority</label>
            <select id="priority" name="priority" class="form-control">
                <option value="low">Low Priority</option>
                <option value="medium" selected>Medium Priority</option>
                <option value="high">High Priority</option>
                <option value="critical">Critical Emergency</option>
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <label for="description"><i class="fas fa-align-left"></i> Detailed Description</label>
        <textarea id="description" name="description" class="form-control" rows="5" required 
                  placeholder="Please describe the issue in detail..."></textarea>
    </div>
    
    <!-- Image Upload Section -->
    <div class="form-group">
        <label><i class="fas fa-camera"></i> Upload Evidence</label>
        <div class="camera-preview" id="cameraPreview">
            <div id="previewText">
                <i class="fas fa-image fa-3x" style="color: #6c757d;"></i>
                <p>No image selected</p>
            </div>
            <img id="imagePreview" style="display: none;">
        </div>
        
        <div class="camera-controls">
            <input type="file" id="imageInput" name="image" accept="image/*" capture="environment" 
                   style="display: none;" onchange="previewImage(event)">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('imageInput').click()">
                <i class="fas fa-folder-open"></i> Choose from Gallery
            </button>
            <button type="button" class="btn btn-primary" onclick="capturePhoto()">
                <i class="fas fa-camera"></i> Take Photo
            </button>
            <button type="button" class="btn btn-danger" onclick="clearImage()" id="clearBtn" style="display: none;">
                <i class="fas fa-trash"></i> Clear
            </button>
        </div>
    </div>
    
    <!-- GPS Location -->
    <div class="form-group">
        <label><i class="fas fa-map-marker-alt"></i> Location</label>
        <div class="gps-display">
            <p>Click the button to get your current location:</p>
            <button type="button" class="btn btn-secondary" onclick="getLocation()">
                <i class="fas fa-location-arrow"></i> Get Current Location
            </button>
            
            <div class="gps-info" id="gpsInfo" style="display: none;">
                <div>
                    <p><strong>Latitude:</strong> <span id="latitudeDisplay"></span></p>
                    <input type="hidden" id="latitude" name="latitude">
                </div>
                <div>
                    <p><strong>Longitude:</strong> <span id="longitudeDisplay"></span></p>
                    <input type="hidden" id="longitude" name="longitude">
                </div>
            </div>
        </div>
        
        <div style="margin-top: 1rem;">
            <label for="address"><i class="fas fa-map-pin"></i> Address Details</label>
            <input type="text" id="address" name="address" class="form-control" 
                   placeholder="e.g., Near Central Park, Main Road, Sector 5">
        </div>
    </div>
    
    <div style="margin-top: 2rem; display: flex; gap: 10px;">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Submit Complaint
        </button>
        <button type="button" class="btn" onclick="window.history.back()">
            <i class="fas fa-times"></i> Cancel
        </button>
    </div>
</form>

<!-- Camera Modal -->
<div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
     background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px;">
    <div style="position: absolute; top: 20px; right: 20px;">
        <button onclick="closeCamera()" class="btn btn-danger" style="font-size: 1.5rem;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <video id="cameraVideo" autoplay style="width: 100%; height: 80%; object-fit: contain;"></video>
    <div style="text-align: center; margin-top: 20px;">
        <button onclick="captureFromCamera()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
            <i class="fas fa-camera"></i> Capture Photo
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let stream = null;

function previewImage(event) {
    const input = event.target;
    const preview = document.getElementById('imagePreview');
    const previewText = document.getElementById('previewText');
    const clearBtn = document.getElementById('clearBtn');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            previewText.style.display = 'none';
            clearBtn.style.display = 'inline-block';
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

function capturePhoto() {
    document.getElementById('cameraModal').style.display = 'block';
    startCamera();
}

function startCamera() {
    const video = document.getElementById('cameraVideo');
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(mediaStream) {
                stream = mediaStream;
                video.srcObject = mediaStream;
            })
            .catch(function(err) {
                console.log("Camera error: " + err);
                alert("Unable to access camera. Please check permissions.");
            });
    }
}

function captureFromCamera() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convert to blob and create file
    canvas.toBlob(function(blob) {
        const file = new File([blob], 'camera_photo.jpg', { type: 'image/jpeg' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('imageInput').files = dataTransfer.files;
        
        // Update preview
        const preview = document.getElementById('imagePreview');
        const previewText = document.getElementById('previewText');
        const clearBtn = document.getElementById('clearBtn');
        
        preview.src = URL.createObjectURL(blob);
        preview.style.display = 'block';
        previewText.style.display = 'none';
        clearBtn.style.display = 'inline-block';
        
        closeCamera();
    }, 'image/jpeg');
}

function closeCamera() {
    const modal = document.getElementById('cameraModal');
    modal.style.display = 'none';
    
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
}

function clearImage() {
    document.getElementById('imageInput').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('previewText').style.display = 'block';
    document.getElementById('clearBtn').style.display = 'none';
}

function getLocation() {
    if (navigator.geolocation) {
        document.querySelector('#gpsInfo + .btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                document.getElementById('latitudeDisplay').textContent = lat.toFixed(6);
                document.getElementById('longitudeDisplay').textContent = lng.toFixed(6);
                document.getElementById('gpsInfo').style.display = 'flex';
                
                // Reverse geocoding (simplified)
                getAddressFromCoordinates(lat, lng);
                
                document.querySelector('#gpsInfo + .btn').innerHTML = '<i class="fas fa-check-circle"></i> Location Captured';
                document.querySelector('#gpsInfo + .btn').classList.remove('btn-secondary');
                document.querySelector('#gpsInfo + .btn').classList.add('btn-success');
            },
            function(error) {
                console.error("Geolocation error: ", error);
                alert("Unable to get location. Please enter address manually.");
                document.querySelector('#gpsInfo + .btn').innerHTML = '<i class="fas fa-location-arrow"></i> Get Current Location';
            }
        );
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}

function getAddressFromCoordinates(lat, lng) {
    // In a real application, you would use a geocoding service like Nominatim
    // This is a simplified version
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(response => response.json())
        .then(data => {
            if (data.display_name) {
                document.getElementById('address').value = data.display_name;
            }
        })
        .catch(() => {
            // Fallback address
            document.getElementById('address').value = `Near coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        });
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    
    if (!title || !description) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return false;
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}