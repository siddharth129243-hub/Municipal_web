{% extends "base.html" %}

{% block title %}Admin Dashboard - Municipal Compiler{% endblock %}

{% block content %}
<div class="fade-in">
    <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
    <p>Welcome, Administrator! Manage the municipal complaint system.</p>
</div>

<!-- Statistics -->
<div class="dashboard-grid">
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div>
                <h3>Total Complaints</h3>
                <p class="card-label">All time</p>
            </div>
        </div>
        <div class="card-value">{{ stats.total_complaints }}</div>
    </div>
    
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon" style="background: var(--warning-color);">
                <i class="fas fa-clock"></i>
            </div>
            <div>
                <h3>Pending</h3>
                <p class="card-label">Awaiting action</p>
            </div>
        </div>
        <div class="card-value">{{ stats.pending_complaints }}</div>
    </div>
    
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon" style="background: var(--success-color);">
                <i class="fas fa-check-circle"></i>
            </div>
            <div>
                <h3>Resolved</h3>
                <p class="card-label">Completed issues</p>
            </div>
        </div>
        <div class="card-value">{{ stats.resolved_complaints }}</div>
    </div>
    
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon" style="background: var(--secondary-color);">
                <i class="fas fa-users"></i>
            </div>
            <div>
                <h3>Total Users</h3>
                <p class="card-label">Registered users</p>
            </div>
        </div>
        <div class="card-value">{{ stats.total_users }}</div>
    </div>
</div>

<!-- AI Road Analysis -->
<div class="ai-analysis fade-in">
    <h2><i class="fas fa-brain"></i> AI Road Analysis</h2>
    <p>Roads with most problems (sorted by priority)</p>
    
    <div style="margin: 1rem 0;">
        <div id="roadChart" style="height: 300px; margin: 1rem 0;">
            <!-- Chart would be implemented with Chart.js in real app -->
            <div style="display: flex; align-items: flex-end; height: 250px; gap: 10px; padding: 20px; border: 1px solid #e9ecef; border-radius: 10px;">
                {% for road in roads %}
                <div style="flex: 1; text-align: center;">
                    <div style="height: {{ road.problem_score * 20 }}px; background: var(--danger-color); border-radius: 5px 5px 0 0;"></div>
                    <div style="font-size: 0.8rem; margin-top: 5px;">{{ road.road_name[:10] }}...</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="road-list">
        {% for road in roads %}
        <div class="road-item">
            <div>
                <h4>{{ road.road_name }}</h4>
                <p><i class="fas fa-map-marker-alt"></i> {{ road.taluka }} | 
                   Total: {{ road.total_complaints }} | 
                   Pending: {{ road.pending_complaints }}</p>
            </div>
            <div>
                <div class="problem-score">
                    <div class="score-bar" style="width: {{ road.problem_score * 10 }}%;"></div>
                </div>
                <p style="text-align: center; margin-top: 5px; font-weight: bold;">
                    Score: {{ "%.1f"|format(road.problem_score) }}
                </p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Recent Complaints -->
<div class="complaints-list fade-in">
    <h2><i class="fas fa-history"></i> Recent Complaints</h2>
    
    {% for complaint in recent_complaints %}
    <div class="complaint-item">
        <div class="complaint-header">
            <div>
                <h3>{{ complaint.title }}</h3>
                <p><i class="fas fa-user"></i> {{ complaint.author.username }} | 
                   <i class="fas fa-map-marker-alt"></i> {{ complaint.taluka }}</p>
                <p><i class="fas fa-calendar"></i> {{ complaint.created_at.strftime('%d %b %Y, %I:%M %p') }}</p>
            </div>
            <div class="complaint-status status-{{ complaint.status.replace('_', '-') }}">
                {{ complaint.status|replace('_', ' ')|title }}
            </div>
        </div>
        
        <p>{{ complaint.description[:200] }}...</p>
        
        <div style="margin-top: 1rem; display: flex; gap: 10px; flex-wrap: wrap;">
            <span class="btn" style="background: #e9ecef;">
                <i class="fas fa-tag"></i> {{ complaint.category }}
            </span>
            <span class="btn" style="background: #e9ecef;">
                <i class="fas fa-flag"></i> {{ complaint.priority|title }}
            </span>
            
            {% if complaint.status == 'pending' %}
            <button class="btn btn-primary" onclick="assignComplaint({{ complaint.id }})">
                <i class="fas fa-user-tie"></i> Assign Officer
            </button>
            {% endif %}
            
            {% if complaint.image_path %}
            <a href="{{ url_for('uploaded_file', filename=complaint.image_path.split('/')[-1]) }}" 
               target="_blank" class="btn btn-secondary">
                <i class="fas fa-eye"></i> View Image
            </a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Officer Assignment Modal -->
<div id="assignModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
     background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px;">
    <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 500px; margin: 50px auto;">
        <h3><i class="fas fa-user-tie"></i> Assign to Officer</h3>
        <p>Select an officer to handle this complaint:</p>
        
        <div id="officerList" style="margin: 1rem 0;">
            <!-- Officers will be loaded here -->
            <div class="spinner"></div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 1rem;">
            <button onclick="confirmAssignment()" class="btn btn-primary">
                <i class="fas fa-check"></i> Assign
            </button>
            <button onclick="closeAssignModal()" class="btn">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentComplaintId = null;

function assignComplaint(complaintId) {
    currentComplaintId = complaintId;
    document.getElementById('assignModal').style.display = 'block';
    
    // Load officers
    fetch('/api/officers')
        .then(response => response.json())
        .then(officers => {
            const officerList = document.getElementById('officerList');
            officerList.innerHTML = '';
            
            officers.forEach(officer => {
                const div = document.createElement('div');
                div.className = 'officer-option';
                div.style.cssText = 'padding: 10px; border: 2px solid #e1e5eb; border-radius: 10px; margin-bottom: 10px; cursor: pointer;';
                div.innerHTML = `
                    <h4>${officer.username}</h4>
                    <p><i class="fas fa-map-marker-alt"></i> ${officer.taluka} | 
                       <i class="fas fa-building"></i> ${officer.department || 'N/A'}</p>
                    <input type="radio" name="selectedOfficer" value="${officer.id}" style="display: none;">
                `;
                
                div.addEventListener('click', function() {
                    document.querySelectorAll('.officer-option').forEach(opt => {
                        opt.style.borderColor = '#e1e5eb';
                    });
                    this.style.borderColor = 'var(--primary-color)';
                    this.querySelector('input').checked = true;
                });
                
                officerList.appendChild(div);
            });
        });
}

function confirmAssignment() {
    const selected = document.querySelector('input[name="selectedOfficer"]:checked');
    if (!selected) {
        alert('Please select an officer');
        return;
    }
    
    window.location.href = `/complaint/assign/${currentComplaintId}/${selected.value}`;
}

function closeAssignModal() {
    document.getElementById('assignModal').style.display = 'none';
}

// Load road analysis data
fetch('/api/roads/analysis')
    .then(response => response.json())
    .then(data => {
        console.log('Road analysis:', data);
        // Could use Chart.js here for better visualization
    });
</script>
{% endblock %}